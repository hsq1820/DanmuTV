# GitHub Actions 构建问题分析与修复

## 📋 问题总结

根据 GitHub Actions 构建日志分析,发现以下问题:

### 1. ❌ Linux 构建失败
**日志**: `build (ubuntu-latest)/8_Build for Linux.txt`

**错误信息**:
```
⨯ GitHub Personal Access Token is not set, neither programmatically, nor using env "GH_TOKEN"
ELIFECYCLE  Command failed with exit code 1.
```

**原因**:
- electron-builder 检测到 git tag `v1.0.0`
- 配置中设置了 `artifacts will be published  reason=tag is defined tag=v1.0.0`
- 尝试发布到 GitHub Release,但缺少 `GH_TOKEN` 环境变量

**构建进度**:
- ✅ Next.js 构建成功 (17秒)
- ✅ 类型检查和静态页面生成成功
- ✅ Electron 打包成功
- ✅ AppImage 下载成功
- ❌ 发布到 GitHub 时失败 (缺少 token)

---

### 2. ❌ macOS 构建被取消
**日志**: `build (macos-latest)/7_Build for macOS.txt`

**错误信息**:
```
The operation was canceled.
```

**构建进度**:
- ✅ Next.js 构建成功 (14秒)
- ✅ 类型检查和静态页面生成成功
- ✅ x64 架构打包成功
- ✅ x64 DMG 构建成功
- ✅ arm64 架构打包成功
- ✅ arm64 DMG 构建成功
- ✅ 两个 blockmap 文件构建成功
- ❌ 在 12:15:05 被取消

**分析**:
- macOS 构建本身成功了
- 但由于 Linux 构建失败,整个工作流被取消
- 已生成的文件:
  - `DanmuTV-1.0.0.dmg` (Intel Mac)
  - `DanmuTV-1.0.0-arm64.dmg` (Apple Silicon)
  - 对应的 blockmap 文件

---

### 3. ❌ Windows 构建被取消
**日志**: `build (windows-latest)/6_Build for Windows.txt`

**错误信息**:
```
Creating an optimized production build ...
Terminate batch job (Y/N)? 
The operation was canceled.
```

**构建进度**:
- 🔄 Next.js 构建进行中 (运行了20秒)
- ❌ 在编译阶段被取消

**分析**:
- Windows 构建刚开始就被取消
- 应该是 Linux 快速失败导致整个工作流终止

---

## 🔧 解决方案

### 修复 1: 添加 GH_TOKEN 环境变量

**修改前**:
```yaml
- name: Build for Linux
  if: matrix.os == 'ubuntu-latest'
  run: pnpm electron:build:linux
```

**修改后**:
```yaml
- name: Build for Linux
  if: matrix.os == 'ubuntu-latest'
  run: pnpm electron:build:linux
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

**同样修改 Windows 和 macOS**:
```yaml
- name: Build for Windows
  if: matrix.os == 'windows-latest'
  run: pnpm electron:build:win
  env:
    CSC_IDENTITY_AUTO_DISCOVERY: false
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

- name: Build for macOS
  if: matrix.os == 'macos-latest'
  run: pnpm electron:build:mac
  env:
    CSC_IDENTITY_AUTO_DISCOVERY: false
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

### 修复 2: 禁用自动发布 (可选方案)

如果不想让 electron-builder 自动发布,可以添加 `--publish never`:

**package.json**:
```json
{
  "scripts": {
    "electron:build:win": "next build && electron-builder --win --x64 --publish never",
    "electron:build:mac": "next build && electron-builder --mac --publish never",
    "electron:build:linux": "next build && electron-builder --linux --publish never"
  }
}
```

但这样的话,electron-builder 就不会将文件准备好供 GitHub Actions 上传。

**推荐**: 使用修复方案 1,让 electron-builder 知道如何上传。

---

## ✅ 修复后的预期结果

### Linux
```
✓ Next.js 构建成功
✓ Electron 打包成功
✓ AppImage 生成成功
✓ 文件上传到 artifacts
```

生成文件:
- `DanmuTV-1.0.0.AppImage` (~160 MB)

### macOS
```
✓ Next.js 构建成功
✓ x64 DMG 生成成功
✓ arm64 DMG 生成成功
✓ 文件上传到 artifacts
```

生成文件:
- `DanmuTV-1.0.0.dmg` (Intel Mac, ~120 MB)
- `DanmuTV-1.0.0-arm64.dmg` (Apple Silicon, ~115 MB)
- 对应的 `.blockmap` 文件

### Windows
```
✓ Next.js 构建成功
✓ NSIS 安装包生成成功
✓ 便携版生成成功
✓ 文件上传到 artifacts
```

生成文件:
- `DanmuTV Setup 1.0.0.exe` (~135 MB)
- `DanmuTV 1.0.0.exe` (~135 MB)
- 对应的 `.blockmap` 文件

---

## 📝 修复步骤

1. **更新 GitHub Actions 配置**:
   ```bash
   # 已完成,文件已修改: .github/workflows/build.yml
   ```

2. **提交更改**:
   ```bash
   git add .github/workflows/build.yml
   git commit -m "fix: 添加 GH_TOKEN 修复构建失败问题"
   git push origin main
   ```

3. **删除旧 tag 并重新创建**:
   ```bash
   # 删除本地 tag
   git tag -d v1.0.0
   
   # 删除远程 tag
   git push origin :refs/tags/v1.0.0
   
   # 重新创建 tag
   git tag v1.0.0
   
   # 推送新 tag
   git push origin v1.0.0
   ```

4. **等待构建完成**:
   - 进入 GitHub Actions 页面
   - 查看新的构建进度
   - 预计 15-20 分钟完成

---

## 🎯 构建时间估算

基于日志分析:

| 平台 | Next.js 构建 | Electron 打包 | 总时间 | 状态 |
|------|-------------|--------------|--------|------|
| **Linux** | ~17 秒 | ~12 秒 | ~30 秒 | ✅ 将成功 |
| **macOS** | ~14 秒 | ~40 秒 | ~55 秒 | ✅ 将成功 |
| **Windows** | ~20 秒 | ~30 秒 | ~50 秒 | ✅ 将成功 |

所有平台并行执行,总时间约 **1 分钟**。

---

## 🐛 其他观察

### 1. 构建缓存警告
所有平台都显示:
```
⚠ No build cache found. Please configure build caching for faster rebuilds.
```

**可优化**: 配置 GitHub Actions 缓存加速构建

**优化方案**:
```yaml
- name: Cache Next.js
  uses: actions/cache@v3
  with:
    path: |
      .next/cache
    key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}
```

### 2. Edge Runtime 警告
所有平台都显示:
```
⚠ Using edge runtime on a page currently disables static generation for that page
```

**位置**: 某个页面使用了 `export const runtime = 'edge'`

**影响**: 该页面无法静态生成,只能服务端渲染 (对 Electron 应用无影响)

### 3. 遥测提醒
所有平台都显示 Next.js 遥测信息,可以通过设置环境变量禁用:
```yaml
env:
  NEXT_TELEMETRY_DISABLED: 1
```

---

## ✅ 修复确认

修复已完成:
- ✅ 已添加 `GH_TOKEN` 到所有构建步骤
- ✅ 保留了代码签名禁用配置
- ✅ 准备好重新推送 tag

下一步:
1. 提交修复
2. 删除并重新创建 v1.0.0 tag
3. 等待构建完成
4. 验证所有平台的构建产物

---

## 📊 成功标志

构建成功后,你应该看到:

**Artifacts**:
- `danmutv-windows-latest` (含 3-4 个文件)
- `danmutv-macos-latest` (含 4-6 个文件)
- `danmutv-ubuntu-latest` (含 1-2 个文件)

**Release Assets**:
- 所有平台的安装包
- blockmap 文件
- latest*.yml 配置文件

总计约 10-12 个文件,总大小约 500-600 MB。

---

Made with 🔧 for DanmuTV
