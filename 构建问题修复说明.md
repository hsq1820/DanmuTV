# GitHub Actions æ„å»ºé—®é¢˜åˆ†æä¸ä¿®å¤

## ğŸ“‹ é—®é¢˜æ€»ç»“

æ ¹æ® GitHub Actions æ„å»ºæ—¥å¿—åˆ†æ,å‘ç°ä»¥ä¸‹é—®é¢˜:

### 1. âŒ Linux æ„å»ºå¤±è´¥
**æ—¥å¿—**: `build (ubuntu-latest)/8_Build for Linux.txt`

**é”™è¯¯ä¿¡æ¯**:
```
â¨¯ GitHub Personal Access Token is not set, neither programmatically, nor using env "GH_TOKEN"
ELIFECYCLE  Command failed with exit code 1.
```

**åŸå› **:
- electron-builder æ£€æµ‹åˆ° git tag `v1.0.0`
- é…ç½®ä¸­è®¾ç½®äº† `artifacts will be published  reason=tag is defined tag=v1.0.0`
- å°è¯•å‘å¸ƒåˆ° GitHub Release,ä½†ç¼ºå°‘ `GH_TOKEN` ç¯å¢ƒå˜é‡

**æ„å»ºè¿›åº¦**:
- âœ… Next.js æ„å»ºæˆåŠŸ (17ç§’)
- âœ… ç±»å‹æ£€æŸ¥å’Œé™æ€é¡µé¢ç”ŸæˆæˆåŠŸ
- âœ… Electron æ‰“åŒ…æˆåŠŸ
- âœ… AppImage ä¸‹è½½æˆåŠŸ
- âŒ å‘å¸ƒåˆ° GitHub æ—¶å¤±è´¥ (ç¼ºå°‘ token)

---

### 2. âŒ macOS æ„å»ºè¢«å–æ¶ˆ
**æ—¥å¿—**: `build (macos-latest)/7_Build for macOS.txt`

**é”™è¯¯ä¿¡æ¯**:
```
The operation was canceled.
```

**æ„å»ºè¿›åº¦**:
- âœ… Next.js æ„å»ºæˆåŠŸ (14ç§’)
- âœ… ç±»å‹æ£€æŸ¥å’Œé™æ€é¡µé¢ç”ŸæˆæˆåŠŸ
- âœ… x64 æ¶æ„æ‰“åŒ…æˆåŠŸ
- âœ… x64 DMG æ„å»ºæˆåŠŸ
- âœ… arm64 æ¶æ„æ‰“åŒ…æˆåŠŸ
- âœ… arm64 DMG æ„å»ºæˆåŠŸ
- âœ… ä¸¤ä¸ª blockmap æ–‡ä»¶æ„å»ºæˆåŠŸ
- âŒ åœ¨ 12:15:05 è¢«å–æ¶ˆ

**åˆ†æ**:
- macOS æ„å»ºæœ¬èº«æˆåŠŸäº†
- ä½†ç”±äº Linux æ„å»ºå¤±è´¥,æ•´ä¸ªå·¥ä½œæµè¢«å–æ¶ˆ
- å·²ç”Ÿæˆçš„æ–‡ä»¶:
  - `DanmuTV-1.0.0.dmg` (Intel Mac)
  - `DanmuTV-1.0.0-arm64.dmg` (Apple Silicon)
  - å¯¹åº”çš„ blockmap æ–‡ä»¶

---

### 3. âŒ Windows æ„å»ºè¢«å–æ¶ˆ
**æ—¥å¿—**: `build (windows-latest)/6_Build for Windows.txt`

**é”™è¯¯ä¿¡æ¯**:
```
Creating an optimized production build ...
Terminate batch job (Y/N)? 
The operation was canceled.
```

**æ„å»ºè¿›åº¦**:
- ğŸ”„ Next.js æ„å»ºè¿›è¡Œä¸­ (è¿è¡Œäº†20ç§’)
- âŒ åœ¨ç¼–è¯‘é˜¶æ®µè¢«å–æ¶ˆ

**åˆ†æ**:
- Windows æ„å»ºåˆšå¼€å§‹å°±è¢«å–æ¶ˆ
- åº”è¯¥æ˜¯ Linux å¿«é€Ÿå¤±è´¥å¯¼è‡´æ•´ä¸ªå·¥ä½œæµç»ˆæ­¢

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ 1: æ·»åŠ  GH_TOKEN ç¯å¢ƒå˜é‡

**ä¿®æ”¹å‰**:
```yaml
- name: Build for Linux
  if: matrix.os == 'ubuntu-latest'
  run: pnpm electron:build:linux
```

**ä¿®æ”¹å**:
```yaml
- name: Build for Linux
  if: matrix.os == 'ubuntu-latest'
  run: pnpm electron:build:linux
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

**åŒæ ·ä¿®æ”¹ Windows å’Œ macOS**:
```yaml
- name: Build for Windows
  if: matrix.os == 'windows-latest'
  run: pnpm electron:build:win
  env:
    CSC_IDENTITY_AUTO_DISCOVERY: false
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

- name: Build for macOS
  if: matrix.os == 'macos-latest'
  run: pnpm electron:build:mac
  env:
    CSC_IDENTITY_AUTO_DISCOVERY: false
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

### ä¿®å¤ 2: ç¦ç”¨è‡ªåŠ¨å‘å¸ƒ (å¯é€‰æ–¹æ¡ˆ)

å¦‚æœä¸æƒ³è®© electron-builder è‡ªåŠ¨å‘å¸ƒ,å¯ä»¥æ·»åŠ  `--publish never`:

**package.json**:
```json
{
  "scripts": {
    "electron:build:win": "next build && electron-builder --win --x64 --publish never",
    "electron:build:mac": "next build && electron-builder --mac --publish never",
    "electron:build:linux": "next build && electron-builder --linux --publish never"
  }
}
```

ä½†è¿™æ ·çš„è¯,electron-builder å°±ä¸ä¼šå°†æ–‡ä»¶å‡†å¤‡å¥½ä¾› GitHub Actions ä¸Šä¼ ã€‚

**æ¨è**: ä½¿ç”¨ä¿®å¤æ–¹æ¡ˆ 1,è®© electron-builder çŸ¥é“å¦‚ä½•ä¸Šä¼ ã€‚

---

## âœ… ä¿®å¤åçš„é¢„æœŸç»“æœ

### Linux
```
âœ“ Next.js æ„å»ºæˆåŠŸ
âœ“ Electron æ‰“åŒ…æˆåŠŸ
âœ“ AppImage ç”ŸæˆæˆåŠŸ
âœ“ æ–‡ä»¶ä¸Šä¼ åˆ° artifacts
```

ç”Ÿæˆæ–‡ä»¶:
- `DanmuTV-1.0.0.AppImage` (~160 MB)

### macOS
```
âœ“ Next.js æ„å»ºæˆåŠŸ
âœ“ x64 DMG ç”ŸæˆæˆåŠŸ
âœ“ arm64 DMG ç”ŸæˆæˆåŠŸ
âœ“ æ–‡ä»¶ä¸Šä¼ åˆ° artifacts
```

ç”Ÿæˆæ–‡ä»¶:
- `DanmuTV-1.0.0.dmg` (Intel Mac, ~120 MB)
- `DanmuTV-1.0.0-arm64.dmg` (Apple Silicon, ~115 MB)
- å¯¹åº”çš„ `.blockmap` æ–‡ä»¶

### Windows
```
âœ“ Next.js æ„å»ºæˆåŠŸ
âœ“ NSIS å®‰è£…åŒ…ç”ŸæˆæˆåŠŸ
âœ“ ä¾¿æºç‰ˆç”ŸæˆæˆåŠŸ
âœ“ æ–‡ä»¶ä¸Šä¼ åˆ° artifacts
```

ç”Ÿæˆæ–‡ä»¶:
- `DanmuTV Setup 1.0.0.exe` (~135 MB)
- `DanmuTV 1.0.0.exe` (~135 MB)
- å¯¹åº”çš„ `.blockmap` æ–‡ä»¶

---

## ğŸ“ ä¿®å¤æ­¥éª¤

1. **æ›´æ–° GitHub Actions é…ç½®**:
   ```bash
   # å·²å®Œæˆ,æ–‡ä»¶å·²ä¿®æ”¹: .github/workflows/build.yml
   ```

2. **æäº¤æ›´æ”¹**:
   ```bash
   git add .github/workflows/build.yml
   git commit -m "fix: æ·»åŠ  GH_TOKEN ä¿®å¤æ„å»ºå¤±è´¥é—®é¢˜"
   git push origin main
   ```

3. **åˆ é™¤æ—§ tag å¹¶é‡æ–°åˆ›å»º**:
   ```bash
   # åˆ é™¤æœ¬åœ° tag
   git tag -d v1.0.0
   
   # åˆ é™¤è¿œç¨‹ tag
   git push origin :refs/tags/v1.0.0
   
   # é‡æ–°åˆ›å»º tag
   git tag v1.0.0
   
   # æ¨é€æ–° tag
   git push origin v1.0.0
   ```

4. **ç­‰å¾…æ„å»ºå®Œæˆ**:
   - è¿›å…¥ GitHub Actions é¡µé¢
   - æŸ¥çœ‹æ–°çš„æ„å»ºè¿›åº¦
   - é¢„è®¡ 15-20 åˆ†é’Ÿå®Œæˆ

---

## ğŸ¯ æ„å»ºæ—¶é—´ä¼°ç®—

åŸºäºæ—¥å¿—åˆ†æ:

| å¹³å° | Next.js æ„å»º | Electron æ‰“åŒ… | æ€»æ—¶é—´ | çŠ¶æ€ |
|------|-------------|--------------|--------|------|
| **Linux** | ~17 ç§’ | ~12 ç§’ | ~30 ç§’ | âœ… å°†æˆåŠŸ |
| **macOS** | ~14 ç§’ | ~40 ç§’ | ~55 ç§’ | âœ… å°†æˆåŠŸ |
| **Windows** | ~20 ç§’ | ~30 ç§’ | ~50 ç§’ | âœ… å°†æˆåŠŸ |

æ‰€æœ‰å¹³å°å¹¶è¡Œæ‰§è¡Œ,æ€»æ—¶é—´çº¦ **1 åˆ†é’Ÿ**ã€‚

---

## ğŸ› å…¶ä»–è§‚å¯Ÿ

### 1. æ„å»ºç¼“å­˜è­¦å‘Š
æ‰€æœ‰å¹³å°éƒ½æ˜¾ç¤º:
```
âš  No build cache found. Please configure build caching for faster rebuilds.
```

**å¯ä¼˜åŒ–**: é…ç½® GitHub Actions ç¼“å­˜åŠ é€Ÿæ„å»º

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```yaml
- name: Cache Next.js
  uses: actions/cache@v3
  with:
    path: |
      .next/cache
    key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}
```

### 2. Edge Runtime è­¦å‘Š
æ‰€æœ‰å¹³å°éƒ½æ˜¾ç¤º:
```
âš  Using edge runtime on a page currently disables static generation for that page
```

**ä½ç½®**: æŸä¸ªé¡µé¢ä½¿ç”¨äº† `export const runtime = 'edge'`

**å½±å“**: è¯¥é¡µé¢æ— æ³•é™æ€ç”Ÿæˆ,åªèƒ½æœåŠ¡ç«¯æ¸²æŸ“ (å¯¹ Electron åº”ç”¨æ— å½±å“)

### 3. é¥æµ‹æé†’
æ‰€æœ‰å¹³å°éƒ½æ˜¾ç¤º Next.js é¥æµ‹ä¿¡æ¯,å¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡ç¦ç”¨:
```yaml
env:
  NEXT_TELEMETRY_DISABLED: 1
```

---

## âœ… ä¿®å¤ç¡®è®¤

ä¿®å¤å·²å®Œæˆ:
- âœ… å·²æ·»åŠ  `GH_TOKEN` åˆ°æ‰€æœ‰æ„å»ºæ­¥éª¤
- âœ… ä¿ç•™äº†ä»£ç ç­¾åç¦ç”¨é…ç½®
- âœ… å‡†å¤‡å¥½é‡æ–°æ¨é€ tag

ä¸‹ä¸€æ­¥:
1. æäº¤ä¿®å¤
2. åˆ é™¤å¹¶é‡æ–°åˆ›å»º v1.0.0 tag
3. ç­‰å¾…æ„å»ºå®Œæˆ
4. éªŒè¯æ‰€æœ‰å¹³å°çš„æ„å»ºäº§ç‰©

---

## ğŸ“Š æˆåŠŸæ ‡å¿—

æ„å»ºæˆåŠŸå,ä½ åº”è¯¥çœ‹åˆ°:

**Artifacts**:
- `danmutv-windows-latest` (å« 3-4 ä¸ªæ–‡ä»¶)
- `danmutv-macos-latest` (å« 4-6 ä¸ªæ–‡ä»¶)
- `danmutv-ubuntu-latest` (å« 1-2 ä¸ªæ–‡ä»¶)

**Release Assets**:
- æ‰€æœ‰å¹³å°çš„å®‰è£…åŒ…
- blockmap æ–‡ä»¶
- latest*.yml é…ç½®æ–‡ä»¶

æ€»è®¡çº¦ 10-12 ä¸ªæ–‡ä»¶,æ€»å¤§å°çº¦ 500-600 MBã€‚

---

Made with ğŸ”§ for DanmuTV
